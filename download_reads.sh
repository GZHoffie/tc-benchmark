#!/bin/bash

## Download sra toolkit
mkdir -p tools
cd tools
wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/3.0.10/sratoolkit.3.0.10-ubuntu64.tar.gz
tar -xvf sratoolkit.3.0.10-ubuntu64.tar.gz
rm *.tar.gz
echo "export PATH=\${PATH}:$(pwd)/sratoolkit.3.0.10-ubuntu64/bin" >> ~/.bashrc
source ~/.bashrc

## Download reads using prefetch
cd /mnt/c/Users/guzh/ # Download outside WSL as the size of files is large

mkdir -p tax_data
cd tax_data

# Download the study that contains pseudomonas isolates
#prefetch -v SRP323385

# Download some isolates ONT reads
prefetch -v SRR24651171 SRR24651172 SRR24651173 SRR24651174 SRR24651175 SRR24651176 SRR24651177 SRR24651178 SRR24651179 SRR24651180 SRR24651181 SRR24651182 SRR24651183 SRR24651184 SRR24651185 SRR24651186 SRR24651187 SRR24651188 SRR24651189 SRR24651190 SRR24651191 SRR24651192 SRR24651193 SRR24651194 SRR24651195 SRR24651196 SRR24651197 SRR24651198 SRR24651199 SRR24651200 SRR24651201 SRR24651202 SRR24651203 SRR24651204 SRR24651205 SRR24651206 SRR24651207 SRR24651208 SRR24651209 SRR24651210 SRR24651211 SRR24651212 SRR24651213 SRR24651214 SRR24651215 SRR24651216 SRR24651217 SRR24651218 SRR24651219 SRR24651220 SRR24651221 SRR24651222 SRR24651223 SRR24651224 SRR24651225 SRR24651226 SRR24651227 SRR24651228 SRR24651229 SRR24651230 SRR24651231 SRR24651232 SRR24651233 SRR24651234 SRR24651235 SRR24651236 SRR24651237 SRR24651238 SRR24651239 SRR24651240 SRR24651241 SRR24651242 SRR24651243 SRR24651244 SRR24651245 SRR24651246 SRR24651247 SRR24651248 SRR24651249 SRR24651250 SRR24651251 SRR24651252 SRR24651253 SRR24651254 SRR24651255 SRR24651256 SRR24651257 SRR24651258 SRR24651259 SRR24651260 SRR24651261 SRR24651262 SRR24651263 SRR24651264 SRR24651265 SRR24651266 SRR24651267 SRR24651268 SRR24651269 SRR24651270 SRR24651271 SRR24651272 SRR24651273 SRR24651274 SRR24651275 SRR24651276 SRR24651277 SRR24651278 SRR24651279 SRR24651280 SRR24651281 SRR24651282 SRR24651283 SRR24651284 SRR24651285 SRR24651286 SRR24651287 SRR24651288 SRR24651289 SRR24651290 SRR24651291 SRR24651292 SRR24651293 SRR24651294 SRR24651295 SRR24651296 SRR24651297 SRR24651298 SRR24651299 SRR24651300 SRR24651301 SRR24651302 SRR24651303 SRR24651304 SRR24651305 SRR24651306 SRR24651307 SRR24651308 SRR24651309 SRR24651310 SRR24651311 SRR24651312 SRR24651313 SRR24651314 SRR24651315 SRR24651316 SRR24651317 SRR24651318 SRR24651319 SRR24651320 SRR24651321 SRR24651322 SRR24651323 SRR24651324 SRR24651325 SRR24651326 SRR24651327 SRR24651328 

# Convert all .sra files to .fastq files
for file in ./*/*.sra
do
    fasterq-dump ${file}
    rm ${file}
done

## Record ground truth and sample reads from the isolates
NUM_SAMPLES_PER_FILE=1000
mkdir -p sampled_reads

# Use NCBI esearch to get the tax ID of the read files
sudo apt install ncbi-entrez-direct

for sra_id in *
do
    tax_id=$(esearch -db sra -query $sra_id | efetch -format runinfo | awk -F "," '{print $28}' | sed -n 2p)
    head "./${sra_id}/${sra_id}.fastq" -n $(( NUM_SAMPLES_PER_FILE * 4 )) >> "./sampled_reads/${tax_id}.fastq"
    echo "Sampled dataset ${sra_id} with Tax ID ${tax_id}."
done

